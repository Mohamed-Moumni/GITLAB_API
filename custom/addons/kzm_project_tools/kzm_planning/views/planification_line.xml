<?xml version="1.0" encoding="UTF-8" ?>
<odoo>
    <data>
        <record model="ir.actions.server" id="action_server_approuver">
            <field name="name">Approuver</field>
            <field name="model_id" ref="model_planification_line"/>
            <field name="binding_model_id" ref="model_planification_line"/>
            <field name="state">code</field>
            <field name="code">
                action = records.approve_planification_line()
            </field>
            <field name="groups_id"
                   eval="[(6,0, [ref('kzm_planning.group_validateur_planning')])]"/>
        </record>

        <record model="ir.ui.view" id="planification_line_search_view">
            <field name="name">Planification line Search</field>
            <field name="model">planification.line</field>
            <field name="arch" type="xml">
                <search>
                    <field name="task_id"/>
                    <field name="team_id"/>
                    <field name="contract_id"/>
                    <field name="plafond"/>
                    <field name="planned_hours"/>
                    <field name="effective_hours"/>
                    <field name="remaining_hours"/>
                    <field name="capacity"/>
                    <field name="scrum_master_id"/>
                    <filter name="filter_brouillon_and_to_plan" string="Tasks to plan"
                            domain="[('state','=','draft'), ('to_plan','=',True)]"/>
                    <filter name="filter_termine_and_to_plan" string="Tasks planned"
                            domain="[('state','=','finished'), ('to_plan','=',True)]"/>
                    <filter name="filter_approved_tasks" string="Approved tasks"
                            domain="[('state','=','approved')]"/>
                    <filter name="filter_cancelled_tasks" string="Cancelled tasks"
                            domain="[('state','=','cancelled')]"/>
                    <filter name="filter_no_to_plan" string="Unplanned tasks" domain="[('to_plan','=',False)]"/>
                    <group expand="0" string="Group By">
                        <filter string="Team" name="group_by_team" context="{'group_by':'team_id'}"/>
                    </group>
                </search>
            </field>
        </record>

        <record model="ir.ui.view" id="planification_line_list_view">
            <field name="name">Planification line</field>
            <field name="model">planification.line</field>
            <field name="arch" type="xml">
                <tree multi_edit="1">
                    <field name="task_id" optional="show"/>
                    <field name="team_id" optional="show"/>
                    <field name="contract_id" optional="show"/>
                    <field name="description" optional="show"/>
                    <field name="assign_to_ids" widget="many2many_avatar_user" optional="show"/>
                    <field name="scrum_master_id" widget="many2one_avatar_user" optional="show"/>
                    <field name="plafond" widget="float_time" optional="show"/>
                    <field name="planned_hours" widget="float_time" optional="show"/>
                    <field name="effective_hours" widget="float_time" optional="show"/>
                    <field name="remaining_hours" widget="float_time" optional="show"/>
                    <field name="capacity" optional="show" widget="float_time"/>
                    <field name="estimated_charge" widget="float_time" optional="show"/>
                    <field name="real_charge" widget="float_time" optional="show"/>
                    <field name="difference" widget="float_time" optional="show"/>
                    <field name="to_plan" optional="show"/>
                    <field name="state" decoration-info="state == 'draft'"
                           decoration-warning="state == 'finished'"
                           decoration-success="state == 'approved'"
                           decoration-muted="state == 'canceled'"
                           widget="badge" optional="show"/>
                </tree>
            </field>
        </record>

        <record model="ir.ui.view" id="planification_line_form_view">
            <field name="name">Planification line</field>
            <field name="model">planification.line</field>
            <field name="arch" type="xml">
                <form>
                    <header>
                        <button name="valider_planification_line" string="validate" class="oe_highlight"
                                type="object"
                                attrs="{'invisible': ['|', ('to_plan', '=', False), ('state', 'in', ['finished', 'approved', 'cancelled'])]}"/>
                        <button name="reset_to_draft" string="Reset to draft" class="oe_highlight"
                                type="object" states="finished"/>
                        <button name="reset_to_draft" type="object" string="Reset to draft" class="oe_highlight"
                                states="approved,cancelled" groups="kzm_planning.group_validateur_planning"/>
                        <button name="approve_planification_line" string="Approve" class="oe_highlight"
                                type="object" states="finished" groups="kzm_planning.group_validateur_planning"/>
                        <button name="refuse_planification_line" string="Refuse" class="oe_highlight"
                                type="object" states="finished" groups="kzm_planning.group_validateur_planning"/>
                        <field name="state" widget="statusbar"/>
                    </header>
                    <sheet>
                        <div name="button_box" class="oe_button_box">
                            <button name="action_tickets" type="object" class="oe_stat_button"
                                    icon="fa-tags">
                                <div class="o_stat_info">
                                    <field name="tickets_count" class="o_stat_value"/>
                                    <span class="o_stat_text">Tickets</span>
                                </div>
                            </button>
                            <button name="ressources_sm_action_view" type="object" class="oe_stat_button"
                                    icon="fa-table">
                                <div class="o_field_widget o_stat_info">
                                    <span class="o_stat_value">
                                        <field name="ressources_count"/>
                                    </span>
                                    <span class="o_stat_text">
                                        Ressources
                                    </span>
                                </div>
                            </button>
                        </div>
                        <div>
                            <h1 class="oe_title">
                                <field name="name" readonly="1"/>
                            </h1>
                        </div>
                        <group col="3">
                            <group>
                                <field name="task_id" readonly="1"/>
                                <field name="team_id" readonly="0"/>
                                <field name="contract_id" readonly="1"/>
                                <field name="assign_to_ids" widget="many2many_avatar_user" readonly="1"/>
                                <field name="scrum_master_id" widget="many2one_avatar_user"/>
                                <field name="description" attrs="{'required': [('to_plan', '=', True)]}" widget="html"/>
                                <field name="planification_id" readonly="1"/>
                            </group>
                            <group>
                                <field name="plafond" widget="float_time" readonly="1"/>
                                <field name="planned_hours" widget="float_time" readonly="1"/>
                                <field name="effective_hours" widget="float_time" readonly="1"/>
                                <field name="remaining_hours" widget="float_time" readonly="1"/>
                            </group>
                            <group>
                                <field name="capacity" widget="float_time" readonly="1"/>
                                <field name="estimated_charge" widget="float_time"/>
                                <field name="real_charge" widget="float_time"/>
                                <field name="difference" widget="float_time"/>
                                <field name="to_plan"/>
                            </group>
                        </group>
                        <notebook>
                            <page string="Lignes de planification">
                                <field name="planning_ids">
                                    <tree>
                                        <field name="task_id" readonly="1"/>
                                        <field name="activity_id" readonly="1" invisible="1"/>
                                        <field name="description" required="1"/>
                                        <field name="ticket_id" domain="[('task_id', '=', parent.task_id)]"
                                               context="{'default_task_id':task_id}"/>
                                        <field name="total_charge" widget="float_time"/>
                                    </tree>
                                </field>
                            </page>
                            <page string="Indicators">
                                <group col="3">
                                    <field name="planned_ticket_ids" invisible="1"/>
                                    <field name="not_planned_ticket_ids" invisible="1"/>
                                    <group>
                                        <field name="planned_ticket_ids_count"/>
                                    </group>
                                    <group>
                                        <field name="estimated_charge_planned"/>
                                    </group>
                                    <group>
                                        <field name="real_charge_planned"/>
                                    </group>
                                </group>
                                <group col="3">
                                    <group>
                                        <field name="not_planned_ticket_ids_count"/>
                                    </group>
                                    <group>
                                        <field name="estimated_charge_not_planned"/>
                                    </group>
                                    <group>
                                        <field name="real_charge_not_planned"/>
                                    </group>
                                </group>
                            </page>
                        </notebook>
                    </sheet>
                    <div class="oe_chatter">
                        <field name="message_follower_ids" widget="mail_followers"/>
                        <field name="activity_ids"/>
                        <field name="message_ids" widget="mail_thread"/>
                    </div>
                </form>
            </field>
        </record>
    </data>
</odoo>